前の記事　[「00-02_自作の「レベル」とは」](https://github.com/shinrabansyo/tech-blog/tree/main/Articles/99-%E9%9B%91%E8%AB%87%E3%83%BB%E5%B0%8F%E3%83%8D%E3%82%BF%E9%9B%86/99-01_%E6%A3%AE%E7%BE%85%E4%B8%87%E8%B1%A1%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%8C%E3%81%A7%E3%81%8D%E3%82%8B%E3%81%BE%E3%81%A7%E3%80%81%E3%80%81%E3%80%82)  




# 1.近況報告_Astalisks編

(担当: xxxx) 

あああ  
  

# 2.近況報告_Koonato編

(担当: xxxx) 

あああ


# 3.近況報告_wakuto編

(担当: CPU) 

## Chisel -> Veryl に移行した話

CPU担当のwakutoです。
この章ではCPU開発の中で遭遇したバグと開発言語の移行を進めている話について紹介します！

森羅万象CPUは[Chisel](https://www.chisel-lang.org/)というScalaの内部DSLとして実装されたハードウェア記述言語で書かれています。
クロック信号に同期した回路の記述に特化している特徴もあり、とっても便利にChiselを使わせてもらっていたんですが、最近とあるバグに悩まされることになってしまいました。。。

森羅万象CPUの開発はシミュレーター上で行っています。
しかし、全ての開発をシミュレーター上だけでできるわけではなく、一部の機能はFPGA上に実装して動作を確認する必要があります。
koonatoさんの章で説明した、SPI通信を使ってSDカードの読み書きがまさにFPGA上で動作確認が必要な機能で、バグはこのタイミングで発覚しました。

### シミュレーションと実機動作が一致しなくなった

シミュレーションやFPGAへの実装を行う前に、Chiselで書いたCPUはすべてVerilogに変換します。
シミュレーションを行う場合は変換したコードをVerilatorと呼ばれるVerilogシミュレータに、
FPGAに実装する場合は変換したコードをFPGA開発ツール（今回の場合はGowin EDA）に渡します。

SDカードの読み書きをするプログラムは、SDカードの応答によって動作が変わるため、SDカード実機を使わないとデバッグができません。
シミュレーション上でSDカードの初期化を行うSPIの波形が出てることを確認したのち、実機でSDカードの読み書きをデバッグすることにしました。

CPUをFPGAに書き込んで、SPIの波形をロジックアナライザを使って確認してみると…
なんとSPIの波形が出てません！
SPIの回路は実機でも動作することを確認済みだったので、原因はSPI回路ではなく別のところにありそうです。
シミュレーションではSPIの波形が出ているため、そもそもCPUでプログラムの実行ができているのか確認する必要があります。
特定の処理まで進んだらLEDを１つ点灯させたり、UARTで特定のレジスタの値を出力したりしながら動作がおかしくなる点を絞り込んでいきました。

原因を絞り込んだ結果、なんとメモリの読み書きを行う命令が動作していないことが判明…
関数のプロローグで退避したレジスタがエピローグで正常に復帰できなかったため、プログラムの動作が壊れていたようです。

このバグを解消するにはChiselから変換されたVerilogのなかでメモリアクセスに関する部分で怪しい点を見つける必要があります。
しかし、Chiselから変換されたVerilogは人間が読むことを想定していないため、非常に読みづらく、デバッグが難航しそうですし、あまりやりたくもありません…

直接Verilogを書いていたらバグらなかったのかな、、、でもVerilogも書きづらいしな、、、ということで白羽の矢が立ったのがVerylでした。

### 流行りのHDLに移行しよう

[Veryl](https://doc.veryl-lang.org/book/ja/)はRustライクな構文で書けるあたらしいHDLです。
Chiselでは、信号のビット幅の指定があいまいな場合でも警告が出ない、など意図しないVerilogが生成されやすい問題があります。
生成されたVerilog内ではビット幅が一致しているため、Verilogのリンタなどでチェックすることもできません。

Verylも一度(System)Verilogに変換する必要がありますが、VerylはSystemVerilogの構文とほぼ１対１に対応しているため、意図したVerilogが生成されやすい特徴を持ちます。

また、なんといってもLSPなどの開発支援ツールが整備されている点もうれしいです。
リンタも整備されているため、意図しない挙動になりやすいコードを警告してもらえます。

日本語ドキュメントも充実していて、最近流行り始めている気配を感じたため、Verylに移行することにしました。

### 移行計画

先日最初のステップとして、Verylで生成したトップモジュールからChiselから変換されたVerilogのシミュレーションを実行する環境を整えました。
Chiselで書いたコードがそこそこあるため、しばらくはChiselとVerylのコードが混じった状態で開発を続け、徐々にVerylへの移行を進めていきます。


# 4.近況報告_yn0014編

(担当: xxxx) 

あああ  
